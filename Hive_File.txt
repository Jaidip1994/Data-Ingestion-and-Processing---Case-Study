-- Adding the jar file 
ADD JAR /opt/cloudera/parcels/CDH/lib/hive/lib/hive-hcatalog-core-1.1.0-cdh5.11.2.jar;

-- PARTITION THE DATA  
-- IMPORTANT: BEFORE PARTITIONING ANY TABLE,
SET hive.exec.max.dynamic.partitions=100000;
SET hive.exec.max.dynamic.partitions.pernode=100000;

-- Delete Table if already exists
DROP TABLE new_york_taxi;

-- Create Table 
create external table if not exists new_york_taxi
(
VendorID int,
tpep_pickup_datetime string, 
tpep_dropoff_datetime string,
Passenger_count int,
Trip_distance double, 
PULocationID string, 
DOLocationID string,
RateCodeID int, 
Store_and_fwd_flag string, 
Payment_type int,
Fare_amount double, 
Extra double,
MTA_tax double,
Improvement_surcharge double,
Tip_amount double,
Tolls_amount double,
Total_amount double)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
location '/common_folder/nyc_taxi_data'
tblproperties("skip.header.line.count"="1");

-- To Check whether the Data was imported properly or not
SELECT * from new_york_taxi limit 5;

-- o/p: of the Query
-- new_york_taxi.vendorid	new_york_taxi.tpep_pickup_datetime	new_york_taxi.tpep_dropoff_datetime	new_york_taxi.passenger_count	new_york_taxi.trip_distance	new_york_taxi.pulocationid	new_york_taxi.dolocationid	new_york_taxi.ratecodeid	new_york_taxi.store_and_fwd_flag	new_york_taxi.payment_type	new_york_taxi.fare_amount	new_york_taxi.extra	new_york_taxi.mta_tax	new_york_taxi.improvement_surcharge	new_york_taxi.tip_amount	new_york_taxi.tolls_amount	new_york_taxi.total_amount
-- 1	01-11-17 00:01	01-11-17 00:03	1	0.4	1	N	151	151	2	3.5	0.5	0.5	0	0	0.3	4.8
-- 2	01-11-17 00:31	01-11-17 00:31	1	0	1	N	193	193	2	2.5	0.5	0.5	0	0	0.3	3.8
-- 1	01-11-17 00:25	01-11-17 00:40	1	2.9	1	N	50	249	1	12.5	0.5	0.5	2.75	0	0.3	16.55
-- 1	01-11-17 00:17	01-11-17 00:30	1	3	1	N	79	230	1	11.5	0.5	0.5	2.55	0	0.3	15.35
-- 1	01-11-17 00:38	01-11-17 01:01	1	4.2	1	N	113	33	1	18.5	0.5	0.5	3.95	0	0.3	23.75





-- Part I :Basic Data Quality Checks
-- 1. How many records has each TPEP provider provided? Write a query that summarises the number of records of each provider.
SELECT VendorID , count(*) as no_of_record
from new_york_taxi
group by VendorID;

-- o/p
--  	| vendorid	| no_of_record
-- 1	| 2	        | 647183
-- 2	| 1	        | 527386
-- So for Creative Mobile Technologies : 527386 ( No of Records ) and for VeriFone Inc. : 647183 (No of Records )

-- 2. The data provided is for months November and December only. Check whether the data is consistent, and if not, identify the data quality issues. Mention all data quality issues in comments.

-- Lets the Data Distribution based on Month and Year ( As this will help to partition the Data
SELECT 
year(from_unixtime(unix_timestamp( tpep_pickup_datetime, 'yyyy-MM-dd HH:mm:ss'))) AS year_in_dat , 
month(from_unixtime(unix_timestamp( tpep_pickup_datetime, 'yyyy-MM-dd HH:mm:ss'))) as month_in_dat,
count(*) as Number_of_Records
from new_york_taxi
group by year(from_unixtime(unix_timestamp( tpep_pickup_datetime, 'yyyy-MM-dd HH:mm:ss'))),
         month(from_unixtime(unix_timestamp( tpep_pickup_datetime, 'yyyy-MM-dd HH:mm:ss')));

-- o/p: of the Query         
-- year_in_dat	month_in_dat	number_of_records
-- 2003	1	1
-- 2008	12	2
-- 2009	1	1
-- 2017	11	580300
-- 2017	10	6
-- 2017	12	594255
-- 2018	1	4
-- 
-- As we can see Below some Data are of year 2003, 2008, 2009 ( so these are the data which is not relevant for the current use case )
-- But some data are also there of Oct 2017 and Jan 2018, this is like the Trip started around Midnight

-- To Identify the Number of Null Data in the Dataset
SELECT 
SUM(IF(VendorID IS NULL,1,0)) AS VendorID,
SUM(IF(tpep_pickup_datetime IS NULL,1,0)) AS tpep_pickup_datetime,
SUM(IF(tpep_dropoff_datetime IS NULL,1,0)) AS dropoff_datetime,
SUM(IF(tpep_pickup_datetime IS NULL,1,0)) AS tpep_pickup_datetime,
SUM(IF(Passenger_count IS NULL,1,0)) AS Passenger_count,
SUM(IF(Trip_distance IS NULL,1,0)) AS Trip_distance,
SUM(IF(PULocationID IS NULL,1,0)) AS PULocationID,
SUM(IF(DOLocationID IS NULL,1,0)) AS DOLocationID,
SUM(IF(RateCodeID IS NULL,1,0)) AS RateCodeID,
SUM(IF(Store_and_fwd_flag IS NULL,1,0)) AS Store_and_fwd_flag,
SUM(IF(Payment_type IS NULL,1,0)) AS Payment_type,
SUM(IF(Fare_amount IS NULL,1,0)) AS Fare_amount,
SUM(IF(Extra IS NULL,1,0)) AS Extra,
SUM(IF(MTA_tax IS NULL,1,0)) AS MTA_tax,
SUM(IF(Improvement_surcharge IS NULL,1,0)) AS Improvement_surcharge,
SUM(IF(Tip_amount IS NULL,1,0)) AS Tip_amount,
SUM(IF(Tolls_amount IS NULL,1,0)) AS Tolls_amount,
SUM(IF(Total_amount IS NULL,1,0)) AS Total_amount
from new_york_taxi;

-- o/p
--  	vendorid	tpep_pickup_datetime	dropoff_datetime	tpep_pickup_datetime	passenger_count	trip_distance	pulocationid	dolocationid	ratecodeid	store_and_fwd_flag	payment_type	fare_amount	extra	mta_tax	improvement_surcharge	tip_amount	tolls_amount	total_amount
-- 1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
-- As we can see there are no null records